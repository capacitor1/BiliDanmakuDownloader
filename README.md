# BiliDanmakuDownloader

下载B站视频完整弹幕(携带WBI认证)(修改版，下载ASS)

**这是一个油猴插件。** 需要先在浏览器上安装油猴（[篡改猴](https://www.tampermonkey.net/)）插件后，再导入这个js脚本。

## 说明

非原创插件，而是根据[Bilibili完整弹幕下载器(WBI认证版)](https://greasyfork.org/zh-CN/scripts/517450-bilibili%E5%AE%8C%E6%95%B4%E5%BC%B9%E5%B9%95%E4%B8%8B%E8%BD%BD%E5%99%A8-wbi%E8%AE%A4%E8%AF%81%E7%89%88)（简称WBI版）和[B站bilibil弹幕下载生成ASS字幕](https://chromewebstore.google.com/detail/b%E7%AB%99bilibil%E5%BC%B9%E5%B9%95%E4%B8%8B%E8%BD%BD%E7%94%9F%E6%88%90ass%E5%AD%97%E5%B9%95/dcplofbjeacbmklahfjhnfnpkbdacbgn)（简称ASS版）这两个插件修改合并而来。

## 功能特性

对于原版

- **修改了fetch逻辑，使其可以带上用户cookie。** 此处是WBI版的BUG，如果不带cookie下载会无法得到完整的弹幕数据（B站对于未登录用户只会返回一小部分弹幕）。

- **检查并移除了未知的API接口。** 发现ASS版源码包含几个未知功能的接口，域名为第三方服务器。为了防止可能的信息泄漏和恶意攻击，相关逻辑已被移除。

此修改版

- 保留了上述两个原始插件的主要功能，即：使用WBI签名下载；下载seg.so后合并为一个完整的ass弹幕

- 删除了ASS版中带的附加功能比如时间偏移量和字体大小。现在这些值的设置需要手动修改源码：见`参数调整`部分。

## 参数调整

由于移除了ASS版中的设置页，ASS文件相关的数值必须手动修改，或在下载完成的.ass文件中修改。

修改源码时可以参照下表的解释：

|行|变量名|解释|示例|
|:-:|:-:|:-:|:-:|
|244|u|画面高度|1920|
|245|p|画面宽度|1080|
|246|m|字体大小|17|
|249|n|透明度（HEX字符串）|"80"（此80实为0x80，128）|

## 目前缺陷

原版自身存在的缺陷

- 在网络不佳或其他原因导致下载弹幕分片过程中出现意外，弹幕无法继续下载（遇到错误不能自恢复）。此问题出现在WBI版中。

- 对于超长的视频（比如[【长视频】与Tim在荒岛共度100小时](https://www.bilibili.com/video/BV1rBvNzsE7K)）时，弹幕在大约7小时开始时间码错误，后续弹幕全部错位。目前未知问题具体出在何处，但大概率是在ASS版的时间计算部分。

由于修改而新增的缺陷

- 失去了弹幕排序的功能。这导致下载出的ASS内的行不能按照时间顺序排列，直接打开ass可发现这个问题。但由于ASS的格式特性，播放器在播放时并不会错误，故不影响实际使用。

- 由于是合并两个不同的代码，可能在细节上不到位（如代码优化差、存在未使用变量等），但目前也未发现因此导致的BUG。
